# ๐ ุฏููู ุงูุตูุงุญูุงุช ุงููุงูู - ูุธุงู ุญุงุณุจุฉ ุงูุชูููู

## ๐ฏ ุงูุฃุฏูุงุฑ ุงูุฃุฑุจุนุฉ (4 Roles)

### 1๏ธโฃ ุณูุจุฑ ุฃุฏูู (Super Admin) - Role ID: 1
**ุงููุตูู ุงููุงูู ูููุธุงู ุจุงููุงูู + ุจูุงูุงุช SaaS**

#### ุงูุตูุงุญูุงุช:
- โ **Dashboard**: ูุฑู ุฅุญุตุงุฆูุงุช ุฌููุน ุงูุดุฑูุงุช
- โ **ุงูุนููุงุก**: ูุฑู ุฌููุน ุนููุงุก ุฌููุน ุงูุดุฑูุงุช (ูุง ููุชุฑุฉ)
- โ **ุงูุทูุจุงุช**: ูุฑู ุฌููุน ุทูุจุงุช ุฌููุน ุงูุดุฑูุงุช (ูุง ููุชุฑุฉ)
- โ **ุงูุจููู**: ุฅุถุงูุฉุ ุชุนุฏููุ ุญุฐู ุฌููุน ุงูุจููู
- โ **ุงููุณุชุฎุฏููู**: ุฅุฏุงุฑุฉ ูุงููุฉ ูุฌููุน ุงููุณุชุฎุฏููู
- โ **ุงูุจุงูุงุช ูุงูุงุดุชุฑุงูุงุช**: ุฅุฏุงุฑุฉ ุจุงูุงุช SaaS
- โ **ุงูุชูุงุฑูุฑ**: ุฌููุน ุงูุชูุงุฑูุฑ ูุงูุชุตุฏูุฑ
- โ **ุงูุญุงุณุจุฉ**: ุงุณุชุฎุฏุงู ูุชุตุฏูุฑ ุงููุชุงุฆุฌ

#### ุงูููุชุฑุฉ:
- **ูุง ุชูุฌุฏ ููุชุฑุฉ** - ูุฑู ูู ุงูุจูุงูุงุช ูู ุฌููุน ุงูุดุฑูุงุช
- ูููู ุงุฎุชูุงุฑ `tenant_id` ูุญุฏุฏ ุฅุฐุง ุฃุฑุงุฏ ุฑุคูุฉ ุดุฑูุฉ ูุงุญุฏุฉ

#### ุญุณุงุจ ุงูุงุฎุชุจุงุฑ:
- Username: `admin`
- Password: `Admin@2025`

---

### 2๏ธโฃ ูุฏูุฑ ุดุฑูุฉ (Company Admin) - Role ID: 4
**ุฅุฏุงุฑุฉ ูุงููุฉ ูุดุฑูุชู ููุท (ุนุฏุง ุจูุงูุงุช SaaS)**

#### ุงูุตูุงุญูุงุช:
- โ **Dashboard**: ุฅุญุตุงุฆูุงุช ุดุฑูุชู ููุท
- โ **ุงูุนููุงุก**: ูุฑู ูููุฏูุฑ ุฌููุน ุนููุงุก ุดุฑูุชู
  - ุฅุถุงูุฉุ ุชุนุฏููุ ุญุฐู ุงูุนููุงุก
  - ุชุนููู ุงูุนููุงุก ููููุธููู
- โ **ุงูุทูุจุงุช**: ูุฑู ูููุฏูุฑ ุฌููุน ุทูุจุงุช ุดุฑูุชู
  - ุฅุถุงูุฉุ ุชุนุฏููุ ุญุฐูุ ูุจููุ ุฑูุถ ุงูุทูุจุงุช
- โ **ุงูุจููู**: ุนุฑุถ ููุท (read-only)
- โ **ุงููุณุชุฎุฏููู**: ุฅุฏุงุฑุฉ ููุธูู ุดุฑูุชู ููุท
  - ุฅุถุงูุฉ ููุธูููุ ูุดุฑููู
  - ุชุนุฏูู ุงูุตูุงุญูุงุช
- โ **ุงูุชูุงุฑูุฑ**: ุฌููุน ุชูุงุฑูุฑ ุดุฑูุชู
- โ **ุงูุญุงุณุจุฉ**: ุงุณุชุฎุฏุงู ูุชุตุฏูุฑ

#### ุงูููุชุฑุฉ:
- **ูููุชุฑ ุญุณุจ** `tenant_id` ุงูุฎุงุต ุจุงูุดุฑูุฉ
- ูุง ูุฑู ุจูุงูุงุช ุงูุดุฑูุงุช ุงูุฃุฎุฑู ุฃุจุฏุงู

#### ุญุณุงุจ ุงูุงุฎุชุจุงุฑ:
- Username: `D123456`
- Password: (ููุญุฏุฏ ุนูุฏ ุงูุฅูุดุงุก)

---

### 3๏ธโฃ ูุดุฑู ููุธููู (Supervisor) - Role ID: 5
**ูุฑู ุฌููุน ุจูุงูุงุช ุงูุดุฑูุฉ - ูุฑุงุกุฉ ููุท (Read-Only)**

#### ุงูุตูุงุญูุงุช:
- โ **Dashboard**: ุฅุญุตุงุฆูุงุช ุงูุดุฑูุฉ ูุงููุฉ
- โ **ุงูุนููุงุก**: ูุฑู ุฌููุน ุนููุงุก ุงูุดุฑูุฉ (ุจุฏูู ุชุนุฏูู)
  - **ูุง ููุฌุฏ**: ุฃุฒุฑุงุฑ ุชุนุฏููุ ุญุฐู
  - **ูุง ููุฌุฏ**: ุฒุฑ ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
  - **ูุง ููุฌุฏ**: ุฒุฑ ุชูุฒูุน ุงูุนููุงุก
- โ **ุงูุทูุจุงุช**: ูุฑู ุฌููุน ุทูุจุงุช ุงูุดุฑูุฉ (ุจุฏูู ุชุนุฏูู)
  - **ูุง ููุฌุฏ**: ุฃุฒุฑุงุฑ ุชุนุฏููุ ุญุฐู
  - **ูุง ููุฌุฏ**: ุฒุฑ ุฅุถุงูุฉ ุทูุจ ุฌุฏูุฏ
- โ **ุงูุชูุงุฑูุฑ**: ูุฑู ุฌููุน ุงูุชูุงุฑูุฑ
- โ **ุงูุญุงุณุจุฉ**: ุงุณุชุฎุฏุงู ููุท (ุจุฏูู ุชุตุฏูุฑ)
- โ **ูุง ููููู**: ุชุนุฏูู ุฃู ุจูุงูุงุช
- โ **ูุง ููููู**: ุญุฐู ุฃู ุณุฌูุงุช
- โ **ูุง ููููู**: ุฅุถุงูุฉ ุณุฌูุงุช ุฌุฏูุฏุฉ

#### ุงูููุชุฑุฉ:
- **ูููุชุฑ ุญุณุจ** `tenant_id` ุงูุฎุงุต ุจุงูุดุฑูุฉ
- ูุฑู ุฌููุน ุจูุงูุงุช ุงูุดุฑูุฉ (ุจุฏูู ุชูููุฏ ุนูู ุงูููุธู)

#### ุงูุงุณุชุฎุฏุงู ุงูุฃูุซู:
- ูุซุงูู ูููุดุฑููู ุงูุฐูู ูุญุชุงุฌูู ุฑุคูุฉ ุดุงููุฉ ููุดุฑูุฉ
- ูุชุงุจุนุฉ ุฃุฏุงุก ุงูููุธููู ูุงูุทูุจุงุช
- ุฅุนุฏุงุฏ ุชูุงุฑูุฑ ุฅุฏุงุฑูุฉ

---

### 4๏ธโฃ ุงูููุธู (Employee) - Role ID: 3
**ูุฑู ููุท ุงูุนููุงุก ูุงูุทูุจุงุช ุงููุฎุตุตุฉ ูู**

#### ุงูุตูุงุญูุงุช:
- โ **Dashboard**: ุฅุญุตุงุฆูุงุช ุงูุนููุงุก ุงููุฎุตุตูู ูู ููุท
- โ **ุงูุนููุงุก**: ูุฑู ูููุฏูุฑ ุนููุงุฆู ุงููุฎุตุตูู ููุท
  - ุฅุถุงูุฉุ ุชุนุฏูู ุนููุงุก ุฌุฏุฏ (ุณูุชู ุชุฎุตูุตูุง ูู ุชููุงุฆูุงู)
  - ุญุฐู ุนููุงุฆู
- โ **ุงูุทูุจุงุช**: ูุฑู ูููุฏูุฑ ุทูุจุงุช ุนููุงุฆู ููุท
  - ุฅุถุงูุฉ ุทูุจุงุช ูุนููุงุฆู
  - ุชุนุฏูู ูุญุฐู ุทูุจุงุช ุนููุงุฆู
- โ **ุงูุชูุงุฑูุฑ**: ุชูุงุฑูุฑ ุนููุงุฆู ููุท
- โ **ุงูุญุงุณุจุฉ**: ุงุณุชุฎุฏุงู ูุชุตุฏูุฑ

#### ุงูููุชุฑุฉ:
- **ูููุชุฑ ุญุณุจ** `assigned_to = user_id`
- ูุฑู ููุท ุงูุนููุงุก ุงููุฎุตุตูู ูู ูู ุฌุฏูู `customers.assigned_to`
- ูุฑู ุทูุจุงุช ุงูุชูููู ุงูุฎุงุตุฉ ุจุนููุงุฆู ููุท

#### ููููุฉ ุงูุชุฎุตูุต:
- ูุฏูุฑ ุงูุดุฑูุฉ ูุฐูุจ ุฅูู "ุชูุฒูุน ุงูุนููุงุก"
- ูุฎุชุงุฑ ุงูููุธู
- ูุฎุตุต ูู ุงูุนููุงุก ุงููุทููุจูู
- ูุชู ุชุญุฏูุซ `customers.assigned_to = employee_id`

---

## ๐ง ุงูุชุทุจูู ุงูุชููู

### 1. ุฏุงูุฉ `getUserInfo()`
```typescript
async function getUserInfo(c: any): Promise<{
  userId: number | null;
  tenantId: number | null;
  roleId: number | null;
}>
```

**ุงูุงุณุชุฎุฏุงู:**
```typescript
const userInfo = await getUserInfo(c);

// Super Admin (Role 1) โ tenantId = null (all data)
// Company Admin (Role 4) โ tenantId = 5 (company data)
// Supervisor (Role 5) โ tenantId = 5 (company data, read-only)
// Employee (Role 3) โ userId = 9 (assigned customers only)
```

### 2. ููุชุฑุฉ ุงูุจูุงูุงุช ุญุณุจ ุงูุฏูุฑ

#### ุงูุนููุงุก (Customers):
```typescript
if (userInfo.roleId === 1) {
  // Super Admin: SELECT * FROM customers
} else if (userInfo.roleId === 4 || userInfo.roleId === 5) {
  // Company Admin/Supervisor: WHERE tenant_id = ?
} else if (userInfo.roleId === 3) {
  // Employee: WHERE assigned_to = ?
}
```

#### ุงูุทูุจุงุช (Requests):
```typescript
if (userInfo.roleId === 1) {
  // Super Admin: SELECT * FROM financing_requests
} else if (userInfo.roleId === 4 || userInfo.roleId === 5) {
  // Company Admin/Supervisor: WHERE customers.tenant_id = ?
} else if (userInfo.roleId === 3) {
  // Employee: WHERE customers.assigned_to = ?
}
```

### 3. ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ (UI Permissions)

```typescript
const canEdit = userInfo.roleId !== 5; // Supervisor cannot edit

// ูู HTML:
${canEdit ? `
  <a href="/edit">ุชุนุฏูู</a>
  <a href="/delete">ุญุฐู</a>
` : ''}
```

---

## ๐ ุฌุฏูู ููุงุฑูุฉ ุงูุตูุงุญูุงุช

| ุงูุตูุญุฉ/ุงูุฅุฌุฑุงุก | Super Admin (1) | Company Admin (4) | Supervisor (5) | Employee (3) |
|----------------|-----------------|-------------------|----------------|--------------|
| **Dashboard** | ุฌููุน ุงูุดุฑูุงุช | ุดุฑูุชู ููุท | ุดุฑูุชู ููุท | ุนููุงุฆู ููุท |
| **ุงูุนููุงุก - ุนุฑุถ** | ุงููู | ุดุฑูุชู | ุดุฑูุชู | ุงููุฎุตุตูู ูู |
| **ุงูุนููุงุก - ุฅุถุงูุฉ** | โ | โ | โ | โ (ูู) |
| **ุงูุนููุงุก - ุชุนุฏูู** | โ | โ | โ | โ (ูู) |
| **ุงูุนููุงุก - ุญุฐู** | โ | โ | โ | โ (ูู) |
| **ุงูุทูุจุงุช - ุนุฑุถ** | ุงููู | ุดุฑูุชู | ุดุฑูุชู | ุนููุงุฆู |
| **ุงูุทูุจุงุช - ุฅุถุงูุฉ** | โ | โ | โ | โ |
| **ุงูุทูุจุงุช - ุชุนุฏูู** | โ | โ | โ | โ |
| **ุงูุทูุจุงุช - ุญุฐู** | โ | โ | โ | โ |
| **ุงูุจููู - ุนุฑุถ** | โ | โ | โ | โ |
| **ุงูุจููู - ุฅุถุงูุฉ** | โ | โ | โ | โ |
| **ุงููุณุชุฎุฏููู** | ุงููู | ุดุฑูุชู | โ | โ |
| **ุงูุจุงูุงุช SaaS** | โ | โ | โ | โ |
| **ุงูุชูุงุฑูุฑ** | ุงููู | ุดุฑูุชู | ุดุฑูุชู | ุนููุงุฆู |
| **ุชูุฒูุน ุงูุนููุงุก** | โ | โ | โ | โ |

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ Super Admin:
1. ุชุณุฌูู ุงูุฏุฎูู: `admin` / `Admin@2025`
2. ุงูุฐูุงุจ ุฅูู: `/admin/dashboard`
3. ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุฑุคูุฉ ุฌููุน ุงูุฅุญุตุงุฆูุงุช ูู ูู ุงูุดุฑูุงุช
4. ุงูุฐูุงุจ ุฅูู: `/admin/customers`
5. ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุฑุคูุฉ ุฌููุน ุงูุนููุงุก ูู ุฌููุน ุงูุดุฑูุงุช

### ุงุฎุชุจุงุฑ Company Admin:
1. ุชุณุฌูู ุงูุฏุฎูู: `D123456` / (ูููุฉ ูุฑูุฑ ุงูุดุฑูุฉ)
2. ุงูุฐูุงุจ ุฅูู: `/admin/dashboard`
3. ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุฑุคูุฉ ุฅุญุตุงุฆูุงุช ุดุฑูุชู ููุท (tenant_id=X)
4. ุงูุฐูุงุจ ุฅูู: `/admin/customers`
5. ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุฑุคูุฉ ุนููุงุก ุดุฑูุชู ููุท
6. ุงูุชุญูู: ูุฌูุฏ ุฃุฒุฑุงุฑ "ุฅุถุงูุฉ"ุ "ุชุนุฏูู"ุ "ุญุฐู"

### ุงุฎุชุจุงุฑ Supervisor:
1. ุฅูุดุงุก ุญุณุงุจ ูุดุฑู ุฌุฏูุฏ (Role ID: 5)
2. ุชุณุฌูู ุงูุฏุฎูู
3. ุงูุฐูุงุจ ุฅูู: `/admin/customers`
4. ุงููุชูุฌุฉ ุงููุชููุนุฉ: 
   - ุฑุคูุฉ ุฌููุน ุนููุงุก ุงูุดุฑูุฉ
   - **ุนุฏู ูุฌูุฏ** ุฃุฒุฑุงุฑ "ุชุนุฏูู"ุ "ุญุฐู"
   - **ุนุฏู ูุฌูุฏ** ุฒุฑ "ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ"
5. ุงูุฐูุงุจ ุฅูู: `/admin/requests`
6. ุงููุชูุฌุฉ ุงููุชููุนุฉ:
   - ุฑุคูุฉ ุฌููุน ุทูุจุงุช ุงูุดุฑูุฉ
   - **ุนุฏู ูุฌูุฏ** ุฃุฒุฑุงุฑ "ุชุนุฏูู"ุ "ุญุฐู"

### ุงุฎุชุจุงุฑ Employee:
1. ุฅูุดุงุก ููุธู ุฌุฏูุฏ (Role ID: 3)
2. ุชุฎุตูุต ุนููุงุก ูู ูู ุฎูุงู "ุชูุฒูุน ุงูุนููุงุก"
3. ุชุณุฌูู ุงูุฏุฎูู ูููุธู
4. ุงูุฐูุงุจ ุฅูู: `/admin/customers`
5. ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุฑุคูุฉ ุงูุนููุงุก ุงููุฎุตุตูู ูู ููุท
6. ุงูุฐูุงุจ ุฅูู: `/admin/requests`
7. ุงููุชูุฌุฉ ุงููุชููุนุฉ: ุฑุคูุฉ ุทูุจุงุช ุนููุงุฆู ููุท

---

## ๐ ูุดุฑ ุงูุชุญุฏูุซ ุนูู Hostinger

```bash
# 1. SSH ุฅูู ุงูุณูุฑูุฑ
ssh u928834852@tamweel-calc.com -p 65002

# 2. ุงูุงูุชูุงู ูููุฌูุฏ
cd ~/public_html

# 3. ุณุญุจ ุขุฎุฑ ุชุญุฏูุซุงุช
git pull origin genspark_ai_developer

# 4. ุชุซุจูุช ุงููุชุทูุจุงุช
npm install

# 5. ุชุทุจูู Migration ุงูุฌุฏูุฏ (ููู ุฌุฏุงู!)
npx wrangler d1 execute tamweel-production --remote --file=./migrations/0012_restructure_permissions.sql

# 6. ุจูุงุก ุงููุดุฑูุน
npm run build

# 7. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
pm2 restart tamweel-app
pm2 save

# 8. ุงูุชุญูู ูู Logs
pm2 logs tamweel-app --lines 30
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. **Migration 0012 ุฅูุฒุงูู:**
   - ูุฌุจ ุชุดุบูู `0012_restructure_permissions.sql` ุนูู ุงูุฅูุชุงุฌ
   - ูุถูู Role 5 (Supervisor) ูุน 14 ุตูุงุญูุฉ
   - ูุญุฏูุซ ุฌุฏูู `roles` ู `role_permissions`

### 2. **Token Format:**
   - Token: `user_id:tenant_id:timestamp:random`
   - ูุดูุฑ ุจู Base64
   - ููุณุชุฎุฏู ููุชุญูู ูู ุงููููุฉ ูุงูุตูุงุญูุงุช

### 3. **ููุชุฑุฉ ุงูู tenant_id:**
   - Super Admin: `tenant_id = null` (ูุฑู ุงููู)
   - Company Admin/Supervisor: `tenant_id = X` (ุดุฑูุชู)
   - Employee: `assigned_to = user_id` (ุนููุงุฆู)

### 4. **UI Permissions:**
   - ุงูุฃุฒุฑุงุฑ ุชูุฎูู ุฏููุงููููุงู ุญุณุจ `canEdit` flag
   - Supervisor: `canEdit = false`
   - ุงูุจุงูู: `canEdit = true`

---

## ๐ ุงูุฃูุงู

### 1. **ููุชุฑุฉ SQL ุขููุฉ:**
   - ุงุณุชุฎุฏุงู Prepared Statements
   - Parameterized Queries
   - ุนุฏู ุงุณุชุฎุฏุงู String Concatenation

### 2. **Token Validation:**
   - ุงูุชุญูู ูู ุตูุงุญูุฉ Token
   - Decode ุขูู ูู Base64
   - Fallback ุฅูู query parameters

### 3. **Role-Based Access:**
   - ูุญุต `roleId` ูู ูู endpoint
   - ููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู
   - WHERE clauses ุฏููุงููููุฉ ุญุณุจ ุงูุฏูุฑ

---

## ๐ ุงูุฏุนู ุงูููู

ูููุฒูุฏ ูู ุงููุณุงุนุฏุฉ ุฃู ุงูุงุณุชูุณุงุฑุงุช:
- Git Commit: `0a96de8`
- Branch: `genspark_ai_developer`
- Repository: `https://github.com/basealsyed2015-source/Expense-Master`
- Test Link: `https://8080-iwirje2zy3fybezv7hkxu-b32ec7bb.sandbox.novita.ai`

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-12-21  
**ุงูุฅุตุฏุงุฑ:** 2.0.0 - Complete Permission System
