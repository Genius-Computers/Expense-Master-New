#!/bin/bash

# ๐งช ุณูุฑูุจุช ุงุฎุชุจุงุฑ ุชููุงุฆู ููุณุชุฎุฏู D123456 (Company Admin)
# ูููู ุจุชุณุฌูู ุงูุฏุฎูู ูุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุงูุจูุงูุงุช

BASE_URL="https://8080-iwirje2zy3fybezv7hkxu-b32ec7bb.sandbox.novita.ai"

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐งช ุงุฎุชุจุงุฑ ุตูุงุญูุงุช ูุณุชุฎุฏู D123456"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "๐ ูุนูููุงุช ุงููุณุชุฎุฏู:"
echo "  Username: D123456"
echo "  Password: Aa123456"
echo "  Role ID: 4 (Company Admin)"
echo "  Tenant ID: 1"
echo ""

echo "๐ ุงูุจูุงูุงุช ุงููุชููุนุฉ:"
echo "  โ ุนุฏุฏ ุงูุนููุงุก: 3 (tenant_id = 1)"
echo "  โ ุนุฏุฏ ุงูุทูุจุงุช: 4 (tenant_id = 1)"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "1๏ธโฃ ุงุฎุชุจุงุฑ ุชุณุฌูู ุงูุฏุฎูู..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุชุณุฌูู ุงูุฏุฎูู ูุงูุญุตูู ุนูู Token
LOGIN_RESPONSE=$(curl -s -X POST "$BASE_URL/api/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "D123456",
    "password": "Aa123456"
  }')

echo "Login Response:"
echo "$LOGIN_RESPONSE" | jq '.'

# ุงุณุชุฎุฑุงุฌ Token
TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.token // empty')

if [ -z "$TOKEN" ]; then
    echo "โ ูุดู ุชุณุฌูู ุงูุฏุฎูู!"
    echo "Response: $LOGIN_RESPONSE"
    exit 1
fi

echo "โ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ!"
echo "๐ Token: ${TOKEN:0:50}..."
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "2๏ธโฃ ุงุฎุชุจุงุฑ Dashboard (ุงูุฅุญุตุงุฆูุงุช)..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช Dashboard
DASHBOARD_HTML=$(curl -s "$BASE_URL/admin/dashboard" \
  -H "Authorization: Bearer $TOKEN")

# ุงุณุชุฎุฑุงุฌ ุนุฏุฏ ุงูุนููุงุก ูู HTML
CUSTOMERS_COUNT=$(echo "$DASHBOARD_HTML" | grep -o 'ุฅุฌูุงูู ุงูุนููุงุก.*<p[^>]*>[0-9]\+' | grep -o '[0-9]\+' | head -1)
REQUESTS_COUNT=$(echo "$DASHBOARD_HTML" | grep -o 'ุฅุฌูุงูู ุงูุทูุจุงุช.*<p[^>]*>[0-9]\+' | grep -o '[0-9]\+' | head -1)

echo "๐ ุฅุญุตุงุฆูุงุช Dashboard:"
echo "  ุงูุนููุงุก: $CUSTOMERS_COUNT (ุงููุชููุน: 3)"
echo "  ุงูุทูุจุงุช: $REQUESTS_COUNT (ุงููุชููุน: 4)"

if [ "$CUSTOMERS_COUNT" = "3" ] && [ "$REQUESTS_COUNT" = "4" ]; then
    echo "  โ ุงูุฅุญุตุงุฆูุงุช ุตุญูุญุฉ!"
else
    echo "  โ๏ธ ุงูุฅุญุตุงุฆูุงุช ูุง ุชุทุงุจู ุงููุชููุน"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "3๏ธโฃ ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุนููุงุก..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

CUSTOMERS_HTML=$(curl -s "$BASE_URL/admin/customers?tenant_id=1" \
  -H "Authorization: Bearer $TOKEN")

# ุนุฏ ุนุฏุฏ ุตููู ุงูุนููุงุก ูู ุงูุฌุฏูู
CUSTOMER_ROWS=$(echo "$CUSTOMERS_HTML" | grep -c '<tr class="hover:bg-gray-50"')

echo "๐ ุตูุญุฉ ุงูุนููุงุก:"
echo "  ุนุฏุฏ ุงูุนููุงุก ุงูุธุงูุฑุฉ: $CUSTOMER_ROWS (ุงููุชููุน: 3)"

# ุงูุชุญูู ูู ูุฌูุฏ ุฃุฒุฑุงุฑ ุงูุชุนุฏูู
HAS_EDIT_BUTTON=$(echo "$CUSTOMERS_HTML" | grep -c 'fa-edit')
HAS_DELETE_BUTTON=$(echo "$CUSTOMERS_HTML" | grep -c 'fa-trash')
HAS_ADD_BUTTON=$(echo "$CUSTOMERS_HTML" | grep -c 'ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ')

echo "  ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช:"
echo "    ุชุนุฏูู: $HAS_EDIT_BUTTON โ"
echo "    ุญุฐู: $HAS_DELETE_BUTTON โ"
echo "    ุฅุถุงูุฉ: $HAS_ADD_BUTTON โ"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "4๏ธโฃ ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุทูุจุงุช..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

REQUESTS_HTML=$(curl -s "$BASE_URL/admin/requests?tenant_id=1" \
  -H "Authorization: Bearer $TOKEN")

# ุนุฏ ุนุฏุฏ ุตููู ุงูุทูุจุงุช
REQUEST_ROWS=$(echo "$REQUESTS_HTML" | grep -c '<td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900">')

echo "๐ ุตูุญุฉ ุงูุทูุจุงุช:"
echo "  ุนุฏุฏ ุงูุทูุจุงุช ุงูุธุงูุฑุฉ: $REQUEST_ROWS (ุงููุชููุน: 4)"

# ุงูุชุญูู ูู ูุฌูุฏ ุฃุฒุฑุงุฑ
HAS_EDIT_REQ=$(echo "$REQUESTS_HTML" | grep -c 'fa-edit')
HAS_DELETE_REQ=$(echo "$REQUESTS_HTML" | grep -c 'fa-trash')

echo "  ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช:"
echo "    ุชุนุฏูู: $HAS_EDIT_REQ โ"
echo "    ุญุฐู: $HAS_DELETE_REQ โ"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "5๏ธโฃ ุงุฎุชุจุงุฑ Admin Panel (ููุญุฉ ุงููุตูู ุงูุณุฑูุน)..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ุงูุญุตูู ุนูู Admin Panel HTML
PANEL_HTML=$(curl -s "$BASE_URL/admin/panel" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Cookie: authToken=$TOKEN")

# ุนุฏ ุนุฏุฏ ุงูุฃุฒุฑุงุฑ ูู ููุญุฉ ุงููุตูู ุงูุณุฑูุน
QUICK_ACCESS_BUTTONS=$(echo "$PANEL_HTML" | grep -c 'quick-access-btn')

echo "๐ฏ ููุญุฉ ุงููุตูู ุงูุณุฑูุน:"
echo "  ุฅุฌูุงูู ุงูุฃุฒุฑุงุฑ ูู HTML: $QUICK_ACCESS_BUTTONS"
echo "  ุงููุชููุน ุธููุฑู: 9 ุฃุฒุฑุงุฑ (ุจุนุฏ ุชุทุจูู role_id filter)"
echo ""

# ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฒุฑุงุฑ SaaS
HAS_SAAS=$(echo "$PANEL_HTML" | grep -c 'ุฅุนุฏุงุฏุงุช SaaS')
HAS_TENANTS=$(echo "$PANEL_HTML" | grep -c 'ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช')
HAS_SUBSCRIPTIONS=$(echo "$PANEL_HTML" | grep -c 'ุงูุงุดุชุฑุงูุงุช')

echo "  ุงูุชุญูู ูู ุฅุฎูุงุก ุฃุฒุฑุงุฑ Super Admin:"
if [ "$HAS_SAAS" = "0" ]; then
    echo "    โ ุฅุนุฏุงุฏุงุช SaaS: ูุฎูู"
else
    echo "    โ ุฅุนุฏุงุฏุงุช SaaS: ุธุงูุฑ (ุฎุทุฃ!)"
fi

if [ "$HAS_TENANTS" = "0" ]; then
    echo "    โ ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช: ูุฎูู"
else
    echo "    โ ุฅุฏุงุฑุฉ ุงูุดุฑูุงุช: ุธุงูุฑ (ุฎุทุฃ!)"
fi

if [ "$HAS_SUBSCRIPTIONS" = "0" ]; then
    echo "    โ ุงูุงุดุชุฑุงูุงุช: ูุฎูู"
else
    echo "    โ ุงูุงุดุชุฑุงูุงุช: ุธุงูุฑ (ุฎุทุฃ!)"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ููุฎุต ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

PASSED=0
FAILED=0

# ุชุณุฌูู ุงูุฏุฎูู
if [ -n "$TOKEN" ]; then
    echo "โ ุชุณุฌูู ุงูุฏุฎูู: ูุฌุญ"
    ((PASSED++))
else
    echo "โ ุชุณุฌูู ุงูุฏุฎูู: ูุดู"
    ((FAILED++))
fi

# Dashboard
if [ "$CUSTOMERS_COUNT" = "3" ] && [ "$REQUESTS_COUNT" = "4" ]; then
    echo "โ Dashboard: ุงูุจูุงูุงุช ุตุญูุญุฉ"
    ((PASSED++))
else
    echo "โ๏ธ Dashboard: ุงูุจูุงูุงุช ูุง ุชุทุงุจู"
    ((FAILED++))
fi

# ุงูุตูุงุญูุงุช
if [ "$HAS_EDIT_BUTTON" -gt "0" ] && [ "$HAS_DELETE_BUTTON" -gt "0" ]; then
    echo "โ ุตูุงุญูุงุช ุงูุนููุงุก: ุฃุฒุฑุงุฑ ุงูุชุนุฏูู/ุงูุญุฐู ููุฌูุฏุฉ"
    ((PASSED++))
else
    echo "โ ุตูุงุญูุงุช ุงูุนููุงุก: ุฃุฒุฑุงุฑ ููููุฏุฉ"
    ((FAILED++))
fi

# ุฅุฎูุงุก ุฃุฒุฑุงุฑ Super Admin
if [ "$HAS_SAAS" = "0" ] && [ "$HAS_TENANTS" = "0" ]; then
    echo "โ Admin Panel: ุฃุฒุฑุงุฑ Super Admin ูุฎููุฉ ุจุดูู ุตุญูุญ"
    ((PASSED++))
else
    echo "โ๏ธ Admin Panel: ุจุนุถ ุฃุฒุฑุงุฑ Super Admin ุธุงูุฑุฉ"
    ((FAILED++))
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "ุงููุชูุฌุฉ ุงูููุงุฆูุฉ: $PASSED ูุฌุญ / $((PASSED + FAILED)) ุฅุฌูุงูู"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ $FAILED -eq 0 ]; then
    echo "๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช!"
    exit 0
else
    echo "โ๏ธ ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช"
    exit 1
fi
